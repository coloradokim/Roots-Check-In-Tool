{"version":3,"sources":["webpack:///./public/js/signin.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;AACA,MAAK;AACL;AACA;;AAEA,yDAAwD;AACxD,oDAAmD;AACnD,4CAA2C;AAC3C;AACA,IAAG;AACH;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAE;AACF;AACA;;AAEA;;AAEA;AACA;AACA,GAAE;AACF;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,IAAG;;AAEH;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA,GAAE;AACF;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,GAAE;AACF,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF","file":"SignIn.js","sourcesContent":["// Requires\nvar _ = require('lodash');\nvar moment = require('moment');\nvar $ = require('jquery');\nrequire('jquery.countdown');\n\n// Utils, bound to correct values for event and transition length\nvar startTimes = _.partial( require('../../utils/StartTimes'), EVENT_LENGTH, TRANSITION_LENGTH);\nvar getCurrentEvent = _.partialRight( require('../../utils/GetCurrentEvent'), EVENT_LENGTH, TRANSITION_LENGTH );\n\n// Renders the progress bar at the top of page, using the start time of the student's next (or current) event.\nrenderProgressBar = function(eventStart){\n\n\t$('.countDown').show();\n\tvar currentTime = moment( Date.now() );\n\n\tif (eventStart && currentTime.isAfter( eventStart ) ) {\n\t\treturn null;\n\t} else {\n\t\t$('.timer').countDown({\n\t\t\tstart_time: currentTime, //Time when the progress bar is at 0%\n\t\t\tend_time: eventStart || currentTime.add(1, 'ms'), //Time Progress bar is at 100% and timer runs out, when no eventStart is passed for end_time, use current time with 1 added ms to trigger onComplete and update_progress\n\t\t\tprogress: $('.progress-bar'), //There dom element which should display the progressbar.\n\t\t\tonComplete: function() {\n\t\t\t\t$('.timer').show();\n\t\t\t\t$('.timer').replaceWith(\"<div class=\\\"timer ended\\\">Time's Up!</div>\");\n\t\t\t},\n\t\t\tupdate_progress : function(progress, element){\n\t\t\t\tif (Math.floor(progress) === 50) {\n\t\t\t\t\t$(element).removeClass('progress-bar-success').addClass('progress-bar-warning');\n\t\t\t\t} else if (Math.floor(progress) === 75) {\n\t\t\t\t\t$(element).removeClass('progress-bar-warning').addClass('progress-bar-danger');\n\t\t\t\t}\n\n\t\t\t\telement.attr('aria-valuenow', Math.floor(progress));//We set a custom attribute, 'area-valuenow' containing the progress\n\t\t\t\telement.css('width', Math.floor(progress)+'%');//Fill the bar with percentage of progress\n\t\t\t\telement.text(Math.floor(progress)+'%');//Put text notation of progress inside the progressbar\n\t\t\t}\n\t\t});\n\t}\n}\n\n/*\n\tRender the event data.\n\n\tUses globals from the CONFIG to pair images with locations, activities, creators and focus areas.\n\n\tParses the event based on what data is available.\n*/\nrenderLocationImage = function(eventLocation, eventActivity, eventCreator, focusArea) {\n\n\tif (eventLocation) {\n\t\t$('#locationImage').empty().append( LOCATION_IMAGES[eventLocation.toLowerCase()] );\n\t\t$('#locationText').empty().append(eventLocation);\n\t}\n\n\t// Check if the event activity has an icon, otherwise it is a description and use GET_ACTIVITY\n\tif (eventActivity && ACTIVITY_IMAGES[eventActivity.toLowerCase()]) {\n\t\t$('#activityImage').empty().append( ACTIVITY_IMAGES[eventActivity.toLowerCase()] );\n\t} else {\n\t\t$('#activityImage').empty().append( GET_ACTIVITY(eventActivity) );\n\t}\n\n\t$('#activityText').empty().append(eventActivity || '');\n\n\tif (eventCreator) {\n\t\t$('#creatorImage').empty().append( CREATOR_IMAGES[eventCreator] );\n\t} else if (focusArea) {\n\t\t$('#creatorImage').empty().append( FOCUS_AREAS[focusArea] );\n\t\t$('#creatorText').empty().append(focusArea);\n\t}\n}\n\n/*\n\tUse the getCurrentEvent util to fetch a student's next / current event and display it. Using the same utility as server should ensure that the event being shown is always what will be validated against when a student scans in.\n*/\nfunction renderNextEvent(student) {\n\tvar currentEvent = getCurrentEvent(student);\n\n\t/*\n\t\tIf there is no current event, either we have no grove calendar, in which case we wait until that data is passed in, or the grove calendar needs to reset, in which case we show the first grove calendar event.\n\t*/\n\tif (!currentEvent && _.isEmpty(student.groveCalendar) ) {\n\t\treturn null;\n\t} else if (!currentEvent && !_.isEmpty(student.groveCalendar) ) {\n\t\tcurrentEvent = student.groveCalendar[0];\n\t}\n\n\t// Set data on window so it can be accessed in console for debugging purposes\n\twindow.eventData = currentEvent,\n\twindow.userData = student;\n\n\t// Render the location image with the event data (some of which will not exist, depending on grove vs. google)\n\trenderLocationImage( currentEvent.location,currentEvent.activity || currentEvent.summary, currentEvent.creator, currentEvent.focus_area );\n//renderLocationImage( currentEvent.location,currentEvent.summary, currentEvent.creator);\n\t// Render the prograss bar with the start time, which we get off a google event or using startTimes for grove calender events\n\tvar start = moment( currentEvent.start ) || moment( Date.now() ).add( startTimes(), 'ms' );\n\trenderProgressBar( start );\n}\n\n/*\n\tOnce the user is loaded via Oauth, grab their calendar using google calendar's API, then save it.\n*/\ngetCalendar = function(userData){\n\n\t// Start and end times for calendar\n\tvar start = moment( Date.now() ).startOf('day').toISOString();\n\tvar end = moment( Date.now() ).endOf('day').toISOString();\n\n\t//get users google calendar events starting with today\n\tgapi.client.request('https://www.googleapis.com/calendar/v3/calendars/' + userData.email + '/events/?singleEvents=true&timeMin=' + start + '&timeMax=' + end + '&orderBy=startTime').execute(function(response) {\n\n\t\t// Parse response to put events in correct format and add that to the user data\n\t\tuserData.calendar = _.map(response.items, function(event){\n\t\t\treturn {\n\t\t\t\t\teventId: event.id,\n\t\t\t\t\tlocation: event.location,\n\t\t\t\t\tcreator: event.creator.displayName || event.creator.email,\n\t\t\t\t\tstart: event.start.dateTime,\n\t\t\t\t\tend: event.end.dateTime,\n\t\t\t\t\tdescription: event.description,\n\t\t\t\t\tsummary: event.summary\n\n\t\t\t\t};\n\t\t});\n\n\t\t/*\n\t\t\tNow that we have the student's calendar, we save it in case new events have been added.\n\n\t\t\tBefore waiting for the save to process, we make an initial call to renderNextEvent without waiting for the student object (including grove calendar) to come back. This is to speed up rendering in case the next event is a google calendar event.\n\t\t*/\n\t\t$.ajax ({\n\t\t\ttype: \"POST\",\n\t\t\turl: 'api/user',\n\t\t\tdata: JSON.stringify(userData),\n\t\t\tcontentType: 'application/json',\n\t\t\tsuccess: renderNextEvent\n\t\t});\n\n\t\trenderNextEvent( userData );\n\t});\n}\n\n/* Callback on Oath complete. In global scope so gapi can access it. */\nsigninCallback = function(authResult) {\n\tif (authResult['status']['signed_in']) {\n\n\t\t// Update the app to reflect a signed in user\n\t\t// Hide the sign-in button now that the user is authorized, and show the container\n\t\t$('#signinButton').hide();\n\t\t$('#main-container').show()\n\n\t\t//make call to google profile for users account information\n\t\tgapi.client.request('https://www.googleapis.com/plus/v1/people/me?fields=name(familyName%2Cformatted%2CgivenName)%2CdisplayName%2Cemails%2Fvalue%2Cimage%2Furl%2Cid').execute(function(response) {\n\n\t\t\tvar signInData = {\n\t\t\t\tid: response.id,\n\t\t\t\tname: response.displayName,\n\t\t\t\temail: response.emails[0].value,\n\t\t\t\timage: response.image.url\n\t\t\t}\n\n\t\t\t// Now that we have the ID of the student that signed in, listen for any scans from that student and close this window on scan\n\t\t\tvar handleScan = function(scan) {\n\t\t\t\tif (scan.googleId === response.id) {\n\t\t\t\t\twindow.close();\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tvar tracker = io.connect();\n\t\t\ttracker.on('SCAN!', handleScan);\n\n\t\t\t$('#name').append('<h2>' + response.displayName + '\\'s Next Step</h2>');\n\n\t\t\t//add google id to scan href/link. that way when scan returns scanned_data we have the users id\n\t\t\t$('#scan-button').attr('href', 'scan://scan?callback=https%3A%2F%2Froots-elementary.herokuapp.com/scanredirect/'+response.id);\n\n\t\t\t//get calendar events on signIn and send events/user to database in function above\n\t\t\t$('.scan-button').show();\n\t\t\tgetCalendar(signInData);\n\t});\n\t} else {\n\t\t// Update the app to reflect a signed out user\n\t\t// Possible error values:\n\t\t//   \"user_signed_out\" - User is signed-out\n\t\t//   \"access_denied\" - User denied access to your app\n\t\t//   \"immediate_failed\" - Could not automatically log in the user\n\t\tconsole.log('Sign-in state: ' + authResult['error']);\n\t}\n}\n\nteacherSigninCallback = function(authResult){\n\tif (authResult['status']['signed_in']) {\n\t\t$('#signinButton').hide();\n\n\t\t//make call to google profile for users account information\n\t\tgapi.client.request('https://www.googleapis.com/plus/v1/people/me?fields=name(familyName%2Cformatted%2CgivenName)%2CdisplayName%2Cemails%2Fvalue%2Cimage%2Furl%2Cid').execute(function(response) {\n\n\t\t\tvar signInData = {\n\t\t\t\tid: response.id,\n\t\t\t\tname: response.displayName,\n\t\t\t\t// email: response.emails[0].value,\n\t\t\t\timage: response.image.url\n\t\t\t}\n\t\t\tteacherRedirect(signInData);\n\t\t});\n\n\t}\n\telse{\n\t\tconsole.log('Sign-in state: ' + authResult['error']);\n\t}\n}\n\nteacherRedirect = function(teacherData){\n\t$.ajax ({\n\t\t\ttype: \"POST\",\n\t\t\turl: 'api/teacher',\n\t\t\tdata: JSON.stringify(teacherData),\n\t\t\tcontentType: 'application/json',\n\t\t\tsuccess: function(){\n\t\t\t\twindow.location.href = '/grove-overview';\n\t\t\t}\n\t});\n\n}\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./public/js/signin.js\n ** module id = 0\n ** module chunks = 2\n **/"],"sourceRoot":""}