{"version":3,"sources":["webpack:///./public/js/lost-kids.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA,+E;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA,IAAG;;AAEH;;AAEA;AACA,GAAE;AACF;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;AACF;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,I;AACA;AACA;AACA;AACA;AACA;AACA,G;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA,yBAAwB,oDAAoD;AAC5E;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAI;AACJ;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,IAAG;AACH,GAAE;AACF;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,GAAE;;AAEF;AACA;AACA,uCAAsC,oDAAoD;AAC1F;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAE;;AAEF;AACA;AACA;AACA;AACA,IAAG;AACH,GAAE;;AAEF;AACA;AACA;;AAEA;AACA;AACA,6B;AACA;AACA;AACA,0BAAyB,eAAe;AACxC,IAAG;AACH,GAAE;;AAEF,EAAC","file":"StudentTracker.js","sourcesContent":["// Requires\nvar _      = require('lodash');\nvar moment = require('moment');\nvar $      = require('jquery');\n\n// Utils, bound to correct values for event and transition length\nvar startTimes = _.partial( require('../../utils/StartTimes'), EVENT_LENGTH, TRANSITION_LENGTH);\n\n/* \n\tSorts first by status, showing students that are in the correct center first, and then sorts by first name alphabetically.\n\t@params: Takes in two jQuery objects for use with jQuery's sort\n*/\nfunction sortByNameAndStatus(a, b) {\n\tvar an = $(a).attr('data-name'), bn = $(b).attr('data-name');\n\n\treturn $(b).hasClass('Found') - $(a).hasClass('Found') || (an > bn) - 1 || 1; \n};\n\n/* \n\tPut in a slight delay for student panels to display, then set them all to same height (Not currently using this implementation, but keeping it in case we want to switch back)\n*/\nfunction resizeDisplays() {\n\twindow.setTimeout(function(){\n\t\tvar displays = $('.studentLocationDisplay');\n\n\t\tvar heights = displays.map(function() {\n\t\t\treturn $(this).height()\n\t\t});\n\n\t\tvar maxHeight = Math.max.apply(null, heights);\n\n\t\tdisplays.height(maxHeight);\n\t}, 500);\n}\n\n/*\n\tCreate a nice display out of a string by uppercasing each first letter\n*/\nfunction upperCaseFirst(string) {\n\treturn string.split(' ').map( function(word) {\n\t\treturn word[0].toUpperCase() + word.slice(1);\n\t}).join(' ');\n}\n\n/* \n\tCreates the display for a student.\n\tHave this as a general method instead of on the prototype because it is only called once.\n\n\t@params student: the data for a student (NOTE: this is NOT the class instance, we must bind it for the click handler to properly attach)\n*/\nfunction createStudentDisplay(student) {\n\t// Create the DOM element representing the student\n\tvar display = $('<div>')\n\t\t.addClass('studentLocationDisplay')\n\t\t.addClass('col-md-2')\n\t\t.attr('id', student.googleId)\n\t\t.attr('data-name', student.name);\n\n\tvar container = $('<div>').addClass('nameImageContainer');\n\n\tvar absentToggle = $('<button>')\n\t\t.addClass('btn btn-xs btn-primary absent-toggle')\n\t\t.text( student.absent ? 'Present' : 'Absent');\n\n\tvar toggle = $('<div>').append(absentToggle);\n\tvar info   = $('<div>').addClass('studentInfoContainer')\n\tvar name   = $('<div>').addClass('name').text( student.name );\n\tvar img    = $('<div>').append( $('<img>').addClass('studentImage').attr('src', student.image) );\n\n\tcontainer.append( name ).append( img );\n\n\tdisplay.append( container ).append( info ).append( toggle );\n\t\n\tabsentToggle.on('click', this.toggleAbsent.bind(this));\n\n\treturn display;\n}\n\n// Globals\nvar studentsArray = [];\nvar FILTER = 'All';\n\n// Class of student display\nvar StudentLocationDisplay = function(student) {\n\tthis.data = _.pick(student, ['_id', 'email','name','image','googleId', 'absent']);\n\n\tthis.el = createStudentDisplay.call(this, student);\n\n\t// If student is absent, no need to mess with any of the below data\n\tif (student.absent) {\n\t\tthis.status = 'Absent';\n\t\tthis.updateDisplay();\n\t}\n\t// Look at the student's recent scan to determine if they are in the correct place or not\n\telse if (student.recentScan) {\n\t\tscan = student.recentScan;\n\t\t\n\t\t// First, check if the scan is recent (i.e. if that event is still ongoing)\n\t\tvar recent = false;\n\t\tvar event = scan.event[0];\n\n\t\t// If google event, check against event end\n\t\tif (event && event.end && moment(event.end).subtract(TRANSITION_LENGTH, 'ms').isAfter( Date.now() ) ) {\n\t\t\trecent = true;\n\t\t}\n\t\t// If grove calendar, check against length of events\n\t\telse if (event && !event.end && moment(scan.time).add(EVENT_LENGTH- TRANSITION_LENGTH, 'ms').isAfter( Date.now() ) ) {\n\t\t\trecent = true;\n\t\t}\n\n\t\t// If the scan is recent\n\t\tif (recent) {\n\t\t\tthis.recentScan = scan;\n\t\t\tthis.onScan(scan);\n\t\t} \n\t\t// If the scan is not recent, student is lost\n\t\telse {\n\t\t\tthis.status = 'Lost';\n\t\t\tthis.updateDisplay();\n\t\t}\n\t} \n\t// If there is no recent scan at all, student is lost\n\telse {\n\t\tthis.status = 'Lost';\n\t\tthis.updateDisplay();\n\t}\n\n};\n\n// Toggles absent / present status\nStudentLocationDisplay.prototype.toggleAbsent = function(e) {\n\te.preventDefault();\n\n\tthis.status = this.status === 'Absent' ? 'Lost' : 'Absent';\n\n\tvar self = this;\n\n\t$.post( '/api/user/', { id: this.data.googleId, absent: !this.data.absent }, self.updateDisplay.bind(self) );\n}\n\n/*\n\tUpdates the student's display\n\t1. Check if they are absent or not\n\t2. Update their classes and explanation text\n\t3. If they are lost, we need to get their current event and display that as a correction, in addition to their recent scan, if any.\n*/ \nStudentLocationDisplay.prototype.updateDisplay = function() {\n\n\tif (this.status != 'Absent') {\n\t\tthis.el.find('.absent-toggle').text('Absent');\n\t}\n\n\tif (this.status === 'Found') {\n\t\tvar scannedEvent = this.recentScan.event[0];\n\t\tvar text = _.chain(['summary', 'activity', 'focus_area'])\n\t\t\t.map(function(key) {\n\t\t\t\treturn scannedEvent[key];\n\t\t\t})\n\t\t\t.filter()\n\t\t\t.join(' | ')\n\t\t\t.value()\n\n\t\tvar info = $('<p>').addClass('last-scan-info').addClass('text-primary').text(text);\n\n\t\tthis.el.find('.studentInfoContainer').empty().append(info);\n\t\tthis.el.removeClass('Lost').addClass('Found');\n\t\tthis.render();\n\t}\n\telse if (this.status === 'Lost') {\n\t\tvar self = this;\n\n\t\t// Call the API endpoint to get current event without a scan\n\t\t$.get('/current-event/' + this.data.googleId, function(result) {\n\n\t\t\tself.el.removeClass('Found').addClass('Lost');\n\t\t\t\n\t\t\tvar info = self.el.find('.studentInfoContainer');\n\t\t\tinfo.empty()\n\n\t\t\t// Show correct location\n\t\t\t$('<p>').addClass('correct-location-info text-primary')\n\t\t\t\t.text(result.location)\n\t\t\t\t.appendTo( info );\n\n\t\t\t// If there is a recent scan, show where the student is based on that scan\n\t\t\tif (self.recentScan) {\n\t\t\t\t$('<p>').addClass('last-scan-info text-danger')\n\t\t\t\t\t.text(self.recentScan.scannedLocation)\n\t\t\t\t\t.appendTo( self.el.find('.studentInfoContainer') );\n\t\t\t}\n\n\t\t\t// Move location based on result\n\t\t\tself.currentLocation = result.location;\n\t\t\t\n\t\t\tself.render()\n\t\t});\n\t} else if (this.status === 'Absent') {\n\t\tthis.el.removeClass('Found').addClass('Lost');\n\t\tthis.currentLocation = 'Absent';\n\t\tthis.el.find('.absent-toggle').text('Present');\n\t\tthis.render()\n\t}\n};\n\n/*\n\tRemove the student from their container and move to another, sorting the new container as needed.\n*/\nStudentLocationDisplay.prototype.render = function() {\n\t// Remove if already in DOM\n\tif (this.el) {\n\t\tthis.el.remove();\n\t};\n\n\t// Render into the dom based on where their location is\n\tvar location = $('#' + this.currentLocation.replace(/ /g, '') )\n\tlocation.append(this.el);\n\n\t/*\n\t\tIf we want to put students into a lost container as well as their own, this would be the start... but many issues to deal with, including:\n\t\t1. The absent button event handler, properly binding to the student\n\t\t2. Removing the clone as well as the el above\n\t\t3. Making sure multiple copies don't show up\n\t\t\n\t\tif (this.status = 'Lost') {\n\t\t\t$('#Lost').append( this.el.clone(true) );\n\t\t}\n\t*/\n\n\tvar locationArray = location.find('.studentLocationDisplay').sort( sortByNameAndStatus );\n\n\tlocationArray.detach().appendTo( location );\n\n\t// Re-attach the absent click handler\n\tthis.el.find('.absent-toggle')\n\t\t.off('click')\n\t\t.on('click', this.toggleAbsent.bind(this) );\n};\n\n/*\n\tonScan will either be called based on a scan being received or if a student is automatically checked out based on the event being over.\n\t1. Update their current location if there was a scan.\n\t2. Update their status based on whether the scan was correct or not.\n\t3. If there was a correct scan, set up a new timer.\n\t4. Call updateDisplay\n*/\nStudentLocationDisplay.prototype.onScan = function(scan) {\n\n\tvar self = this;\n\n\tif (scan && scan.correct) {\n\t\tthis.currentLocation = scan.scannedLocation;\n\t\tthis.status = 'Found';\n\n\t\t// Get time until the event is over, either based on the event's end for google calendar events or the startTimes util for grove calendar events\n\t\tvar difference = scan.event[0].end ? moment(scan.event[0].end).subtract( TRANSITION_LENGTH, 'ms').diff( Date.now() ) : startTimes() + EVENT_LENGTH - TRANSITION_LENGTH;\n\t\t\n\t\tthis.transitionTimeout = window.setTimeout( self.onScan.bind(self, null), difference);\n\t}\n\t// If the scan does not match the location, the student is lost\n\telse if (scan) {\n\t\tthis.status = 'Lost';\n\t}\n\t// If there is no scan, the student is lost, and remove their recent scan\n\telse {\n\t\tthis.status = 'Lost';\n\t\tthis.recentScan = null;\n\t}\n\n\t// Now updateDisplay\n\tself.updateDisplay();\n};\n\n// When receiving a scan, find the student that matches the scan, move them to a new location based on the scan and clear any possible transitions\nfunction scanReceived(scan) {\n\n\tvar scanStudent = _.find(studentsArray, function(student) {\n\t\treturn student.data.googleId === scan.googleId;\n\t});\n\n\t// If a student is found, move the student and override their recent scan\n\tif (scanStudent) {\n\t\tif (scanStudent.transitionTimeout) { window.clearTimeout(scanStudent.transitionTimeout); }\n\t\tscanStudent.recentScan = scan;\n\t\t// Call the onScan function, making sure it is bound to the current student\n\t\tscanStudent.onScan.call(scanStudent, scan);\n\t}\n}\n\n/*\n\tOn page load:\n\t1. Create filter buttons and container divs for all the different possible locations, and an extra one for 'Absent'.\n\t2. Load all students using an AJAX call, make StudentLocationDisplay instances for each. Initiating the instance will also move the student to their initial location.\n*/\n$(function(){\n\t['Lost'].concat(_.keys(LOCATION_IMAGES ), 'Absent').forEach( function(location) {\n\t\t\n\t\t// Display, with special protection for iPad Center\n\t\tvar prettyDisplay = location.match(/ipad/i) ? 'iPad Center' : upperCaseFirst(location);\n\n\t\t// Create the filter button and add it to button group\n\t\tvar button = $('<button>').addClass('btn btn-info btn-block').text(prettyDisplay);\n\t\tvar listItem = $('<li>').append(button);\n\t\t$('#location-filters').append(listItem);\n\n\t\t// Create the container\n\t\t$('<div>')\n\t\t\t.addClass('row')\n\t\t\t.attr( 'id', prettyDisplay.replace(/ /g, '') )\n\t\t\t.append( $('<h3>').text(prettyDisplay) )\n\t\t\t.appendTo( $('#locations-container') );\n\t});\n\n\t// Attach event handler to the filter buttons\n\t$('#location-filters button').click(function(e) {\n\t\t\n\t\t// Set filter\n\t\tFILTER = $(this).text();\n\n\t\t// Update display, either showing all or hiding all except the one clicked\n\t\tif (FILTER === 'All') {\n\t\t\t$('#locations-container > div').show();\n\t\t}\n\t\telse {\n\t\t\t$('#locations-container > div').hide();\n\t\t\t$('#' + FILTER.replace(/ /g, '') ).show();\n\t\t}\n\n\t\t// Update the display of the filter buttons by removing primary from all and adding it to this one\n\t\t$('#location-filters button.btn-warning')\n\t\t\t.removeClass('btn-warning')\n\t\t\t.addClass('btn-info');\n\t\t$(this)\n\t\t\t.removeClass('btn-info')\n\t\t\t.addClass('btn-warning');\n\t});\n\t\n\t// Once all the containers are set, make AJAX call to get all the students and create StudentLocationDisplay objects\n\t$.get('api/user', function(students) {\n\t\tstudentsArray = _.map(students, function(student) {\n\t\t\treturn new StudentLocationDisplay(student);\n\t\t});\n\t});\n\n\t// Listen for scans\n\tvar tracker = io.connect();\n\ttracker.on('SCAN!', scanReceived );\n\n\t// All absent event handler\n\t$('.all-absent').on('click', function() {\n\t\t$.ajax('/api/user/bulk', { \n\t\t\ttype: 'PUT',\n\t\t\tcontentType: 'application/json',\n\t\t\tdata: JSON.stringify({ absent: true })\n\t\t});\n\t});\n\t\n});\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./public/js/lost-kids.js\n ** module id = 0\n ** module chunks = 3\n **/"],"sourceRoot":""}